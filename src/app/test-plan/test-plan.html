<div class="layout">

  <button class="burger" [class.open]="isSidebarOpen" (click)="isSidebarOpen = !isSidebarOpen">
    <span></span>
  </button>

    <nav class="sidebar" [class.open]="isSidebarOpen">
      <ul>
        <li *ngFor="let s of steps.controls; let i = index; trackBy: trackByIndex"
            [class.active]="i === selection.values().next().value">
          <button type="button" (click)="scrollToStep(i)">
            {{ i + 1 }}. l√©p√©s
          </button>
        </li>
      </ul>
    </nav>

    <div class="container">
      <h2>TFK</h2>

      <form [formGroup]="testPlanForm">
        <div class="form-group">
          <label>Teszt neve</label>
          <input formControlName="title" type="text" placeholder="Pl.: Bel√©p√©si folyamat" />
        </div>

        <div class="import-card">
          <div class="import-card__header">
            <div class="import-card__icon">üì•</div>
            <div>
              <h3 class="import-card__title">Excel import</h3>
              <p class="import-card__subtitle">V√°laszd ki a f√°jlt √©s a munkalapot, majd import√°lj.</p>
            </div>
          </div>

          <div class="import-card__body">
            <div class="form-group">
              <label>Import√°l√°s megl√©v≈ë Excel f√°jlb√≥l</label>
              <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)"/>
              <small class="hint">Elfogadott form√°tum: .xlsx, .xls</small>
            </div>

            <div class="form-group" *ngIf="sheetNames.length > 0">
              <label>Munkalap kiv√°laszt√°sa</label>
              <select [(ngModel)]="selectedSheetName" [ngModelOptions]="{standalone: true}">
                <option *ngFor="let n of sheetNames" [value]="n">{{ n }}</option>
              </select>
            </div>

            <div class="form-group" *ngIf="sheetNames.length > 0">
              <label>Olvas√°s kezdete (sorsz√°m)</label>
              <input type="number" [ngModel]="startRow" (ngModelChange)="startRow = $event" [ngModelOptions]="{standalone: true}" min="1" />
              <small class="hint">Default: 19</small>
            </div>

            <div class="form-group" *ngIf="sheetNames.length > 0">
              <label>Olvas√°s v√©ge (sorsz√°m)</label>
              <input type="number" [ngModel]="endRow" (ngModelChange)="endRow = $event" [ngModelOptions]="{standalone: true}" min="1" />
              <small class="hint">Ha √ºres, a munkalap v√©g√©ig olvas.</small>
            </div>

          </div>

          <div class="import-card__footer" *ngIf="sheetNames.length > 0">
            <button type="button" class="add-step" (click)="importFromSelectedSheet()">
              Import
            </button>
          </div>
        </div>

        <div formArrayName="steps">
          <div *ngFor="let step of steps.controls; let i = index" [formGroupName]="i" class="step-card" [attr.id]="'step-' + i"> 
            <div class="step-header-row">

              <input type="checkbox" [checked]="selection.has(i)" (change)="toggleSelect(i,$event.target.checked)" title="Kijel√∂l√©s" class="row-checkbox" />

              <h3 class="step-title">{{ i + 1 }}. l√©p√©s</h3>

              <div class="mini-actions">
                <button type="button" class="mini-btn" (click)="copy(i)"  title="M√°sol√°s"> üìã</button>
                <button type="button" class="mini-btn" (click)="paste(i)" [disabled]="!clipboard.length" title="Beilleszt√©s">üì•</button>
              </div>

              <label class="switch">
                <input type="checkbox" formControlName="isSubtest">
                <span class="slider"></span>
                <span class="switch-label">Alteszt c√≠msor</span>
              </label>
            </div>

            <div class="form-group" *ngIf="step.get('isSubtest')?.value; else normalRow">
              <label>Alteszt neve</label>
              <input formControlName="subtestName" type="text"
                    placeholder="Pl.: K√∂zgy√≥gyell√°t√°s szerkeszt√©s - alteszt blokk" />

              <div class="form-group" style="margin-top: 12px;">
                <label>Alteszt h√°tt√©rsz√≠ne</label>
                <input formControlName="subtestColor" type="color" style="width: 56px; height: 32px; padding: 0; border: none;" />
                <small class="hint" style="margin-left:8px;">Default: gray (#929292)</small>
              </div>
            </div>

            <ng-template #normalRow>
              <div class="form-group">
                <label>Funkci√≥</label>
                <input formControlName="function" type="text" />
              </div>

              <div class="form-group">
                <label>El≈ëfelt√©tel</label>
                <textarea formControlName="precondition" rows="6" placeholder="√çrd le az el≈ëfelt√©teleket"></textarea>
              </div>

              <div class="form-group">
                <label>Feladat/Tesztl√©p√©sek</label>
                <textarea formControlName="stepsText" rows="6" placeholder="√çrd le a l√©p√©seket, list√°zva"></textarea>
              </div>
              <div class="form-group">
                <label>Tesztadatok</label>
                <textarea formControlName="testData" rows="6" placeholder="√çrd le a tesztadatokat"></textarea>
              </div>
              <div class="form-group">
                <label>Elv√°rt eredm√©ny</label>
                <textarea formControlName="expected" rows="6" placeholder="√çrd le az elv√°rt kimenetet"></textarea>
              </div>
              <div class="form-group">
                <label>Megjegyz√©s</label>
                <textarea formControlName="comment" rows="6" placeholder="√çrd le a megjegyz√©seket"></textarea>
              </div>
            </ng-template>

            <div class="actions">
              <button type="button" class="add-step" (click)="addStep(i)">√öj l√©p√©s hozz√°ad√°sa</button>
              <button type="button" class="remove-step" (click)="removeStep(i)" [disabled]="steps.length === 1">Sor t√∂rl√©se</button>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="add-step" (click)="exportExcel()">Export Excel</button>
        </div>
      </form>
    </div>
    </div>